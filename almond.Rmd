---
title: "Almond Model"
author: "Anna Abelman, Julia Dagum, Jaleise Hall"
date: "4/8/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
```

### Summary

After developing an R function to represent the California almond yield anomaly regression model from [*Lobell 2006*](https://gauchospace.ucsb.edu/courses/mod/resource/view.php?id=6782707), the yield anomalies for all years 1989 - 2010 were calculated. We found that the year in which there was the most extreme anomaly was in 1995 where the yield anomaly was nearly 2000 ton acre^-1^. There were other much smaller spikes in 1997, 2005, and 2008. With the full production of almond crop being 6 years, we may see such a high spike in 1995 due to the crop reaching it's full maturity. This reasoning requires the assumption that the almond crops studies in *Lobell 2006* were planted at the start of the study period.


```{r}
#read in the clim data
clim <- read.table("clim.txt", sep=" ", header=T)

#read in almond model from function script
source("almond_model.R")
```

**Testing to see if the function works**
```{r}
#create temperature subset for February
temperature <- clim %>%
  filter(month == "2") %>%
  group_by(year) %>%
  summarize(
    avg = mean(tmin_c)
  )

#create precipitation subset for January
rain <- clim %>%
  filter(month == "1") %>%
  group_by(year) %>%
  summarize(
    sum = sum(precip)
  )

# #combine the temperature and precipitation data
df <- data.frame(temperature, rain) %>%
  select(-year.1)
```

### Calculate the Almond Anomaly model
```{r}
#test the model on the clim data
almond_output <- almond_model(clim)
almond_output
```

```{r, fig.cap= "Almond yield anomaly in California for all years 1989 to 2010. The anomaly is calculated using the regression model: Y = -0.015T~n,2~ - 0.0046T^2^~n,2~ - 0.07P~1~ + 0.0043P^2^~1~ + 0.28" }

#turn the model output into a data frame
almond_yield_anomaly <- data.frame(year = df$year, anomaly = almond_model(clim)) %>% 
  mutate(year = lubridate::ymd(year, truncated = 2L))
  
#plot the anomalies
ggplot(data = almond_yield_anomaly, aes(y = anomaly, x = year)) +
  geom_line() +
  scale_x_date(date_breaks = "1 year",
               date_labels = "%Y",
               limits = as.Date(c("1989-01-01","2010-01-01"))) +
  labs(x = "Year",
       y = expression("Anomaly (ton" ~acre^-1~ ")"),
       title = "Annual Almond Yield Anomaly (1989 - 2010)") +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(), 
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))
```
Assignment 3
```{r}
# sensitivity analysis for clim_var4
# create normal distribution 
clim_var4 <- rnorm(n = 500, mean = 0.0043, sd = 0.001)

#res = clim_var4 %>% map_dfc(~almond_model(height=reservoir_model_res$height, flow=reservoir_model_res$flow, Keff=.))
#almond_sens <- map(almond_model, clim_var4, clim=clim)

# use map_dfc to run for each value of clim_var4
almond_sens = clim_var4 %>% map_dfc(~almond_model(clim = clim, clim_var1 = -0.015, clim_var2 = 0.0046, clim_var3 = 0.07, clim_var4 = .x, intercept = 0.28))

# create a vector with years
# year = seq(from=1989, to=2010)
# year_num = as.double(year)

# add another column for each year
# almond_sens$year = year_num

# transpose so that columns are years and rows are clim_var4
almond_sens_transpose <- t(almond_sens)

# rename columns
#colnames(almond_sens_transpose) = almond_sens_transpose$year

# rearrange to plot
almond_sens_plot=as.data.frame(almond_sens_transpose) %>% pivot_longer(everything(),names_to="clim_var4", values_to="anomoly")
ggplot(almond_sens_plot, aes(clim_var4, anomoly, fill=clim_var4))+geom_boxplot() 
#+ labs(y="Power (W/s)", "Efficiency")

#res = clim_var4 %>% map(~almond_model(clim = clim, clim_var4 =.x))

# we can use map to extract named items from a list to a double (numeric)
#map_dbl(res,"final_model")
#resdf = map_dfr(res,`[`, c(1:500))
#resdf = map_dfr(res,`[`, c("mean","min","max"))
#res = map(clim_var4, almond_model, clim = clim) 


#turn the model output into a data frame
#almond_yield_anomaly <- data.frame(year = df$year, anomaly = almond_model(clim)) %>% 
#  mutate(year = lubridate::ymd(year, truncated = 2L))

```

